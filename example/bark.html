<!doctype html>
<html>
  <head>
    <title>bark test</title>
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script>
      function code() {
        return $("#code").text();
      }

      function url() {
        return $("#url").val();   
      }

      function makeRequest() {
        const barkText = $('#bark-input').val();
        return {
          'code_b64': btoa(code()),
          'fn_name': 'run',
          'kwargs_b64': btoa('{"text": "' + barkText + '"}')
        };
      }

      function audioUrl() {
        const request = makeRequest();
        return url() + '?' + $.param(request);
      }

      async function getAudio() {
        let response = await fetch(url(), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(makeRequest())
        });
        console.log('Chunk requested');
        console.log('status', response.status);
        if (!response.ok) {
          throw new Error(await response.text());
        }
        const reader = response.body.getReader();
        var allBlobs = [];
        const stream = new ReadableStream({
          start(controller) {
            return go();
            function go() {
              return reader.read().then(({ done, value }) => {
                if (value) {
                  const blob = new Blob([value], { type: 'audio/wav' });
                  console.log('got blob', blob);
                  allBlobs.push(blob);
                  setAudioDataURL(new Blob(allBlobs, { type: 'audio/wav' }));
                }

                // When no more data needs to be consumed, close the stream
                if (done) {
                  controller.close();
                }
                // Enqueue the next data chunk into our target stream
                controller.enqueue(value);
                return go();
              });
            }
          },
        });
      }

      function setAudioDataURL(blob) {
        const audioDiv = document.getElementById('bark-output');
        const oldAudio = audioDiv.lastChild;
        var time = null;
        var audio;
        if (oldAudio) {
          time = oldAudio.currentTime;
          audio = oldAudio;
        } else {
          audio = new Audio();
          audioDiv.appendChild(audio);
        }
        audio.src = URL.createObjectURL(blob);
        audio.controls = true;
        if (time) {
          audio.currentTime = time;
        }
        audio.play().then(() => {
          console.log('playing');
        }).catch((error) => {
          console.log('error playing', error);
        });
      }

      $(function() {
        console.log("setting download");
        $("#download").attr('href', audioUrl());
      });
    </script>
  </head>
  <body>
    <label for="url">Exec URL</label>
    <input type="text" id="url" value="http://localhost:9876/unsafe/exec/test.wav"></input>
    <label for="bark-input">Text to speak</label>
    <textarea id="bark-input">Test sentence. And a second test.</textarea>
    <button onclick="getAudio()">Speak</button>
    <div id="bark-output"></div>
    <a id="download" href="">Download Speech</a>
    <pre>
      <code id="code" contenteditable="true">
{% include "bark.py" %}
      </code>
    </pre>
  </body>
</html>
