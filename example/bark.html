<!doctype html>
<html>
  <head>
    <title>bark test</title>
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script>
      function code() {
        return $("#code").text();
      }

      function url() {
        return $("#url").val();   
      }

      function makeRequest() {
        const barkText = $('#bark-input').val();
        return {
          'code_b64': btoa(code()),
          'fn_name': 'run',
          'kwargs_b64': btoa('{"text": "' + barkText + '"}')
        };
      }

      function audioUrl() {
        const request = makeRequest();
        return url() + '?' + $.param(request);
      }

      async function getAudio() {
        let response = await fetch(url(), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(makeRequest())
        });
        console.log('Chunk requested');
        console.log('status', response.status);
        if (!response.ok) {
          throw new Error(await response.text());
        }
        const reader = response.body.getReader();
        reader.read().then(({ done, value }) => {
          if (value) {
            setAudioDataURL([value]);
          } 

          // When no more data needs to be consumed, close the stream
          if (done) {
            controller.close();
          }
          // Enqueue the next data chunk into our target stream
          controller.enqueue(value);
          return go();
        });
      }

      const audio = new Audio();

      function setAudioDataURL(values) {
        console.log('setting audio data url', values);
        const blob = new Blob(values, { type: 'audio/wav' });
        console.log('setting audio data url', values, blob);
        audio.src = URL.createObjectURL(blob);
        audio.play();
      }

      $(function() {
        console.log("setting download");
        $("#download").attr('href', audioUrl());
        const audioDiv = document.getElementById('bark-output');
        audio.controls = true;
        audioDiv.appendChild(audio);
        audio.addEventListener('loadeddata', () => {
          audio.play();
        });
      });
    </script>
  </head>
  <body>
    <label for="url">Exec URL</label>
    <input type="text" id="url" value="http://localhost:9876/unsafe/exec/test.wav"></input>
    <label for="bark-input">Text to speak</label>
    <textarea id="bark-input">Test sentence. And a second test.</textarea>
    <button onclick="getAudio()">Speak</button>
    <div id="bark-output"></div>
    <a id="download" href="">Download Speech</a>
    <pre>
      <code id="code" contenteditable="true">
{% include "bark.py" %}
      </code>
    </pre>
  </body>
</html>
