<!doctype html>
<html>
  <head>
    <title>bark test</title>
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
    <script src="/bark/bark.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script>
      function code() {
        return $("#code").text();
      }

      function url() {
        return $("#url").val();   
      }

      function barkText() {
        return $('#bark-input').val();
      }

      function audioUrl(code, text) {
        const request = makeRequest(code, text);
        return url() + '?' + $.param(request);
      }

      function audioChunkHandler(chunk) {
        console.log('audio chunk', chunk);
        const blob = new Blob([chunk], { type: 'audio/wav' });
        setAudioDataURL(blob);
      }

      function audioDoneHandler() {
        console.log('audio done');
      }

      function handleSpeak() {
        return getAudio(url(), code(), barkText(), audioChunkHandler, audioDoneHandler);
      }

      const audio = new Audio();

      function makeAudio(blob) {
        const time = audio.currentTime;
        audio.src = URL.createObjectURL(blob);
        audio.controls = true;
        audio.play().then(() => {
          audio.currentTime = time;
        }).catch((error) => {
          console.error('audio play error', error);
        });
      }

      function setAudioDataURL(blob) {
        const audioDiv = document.getElementById('bark-output');
        audioDiv.replaceChildren(audio);
        console.log('setting audio data url', blob);
        makeAudio(blob);
      }
    </script>
  </head>
  <body>
    <label for="url">Exec URL</label>
    <input type="text" id="url" value="http://localhost:9876/test.wav"></input>
    <label for="bark-input">Text to speak</label>
    <textarea id="bark-input">Test sentence. And a second test.</textarea>
    <button onclick="handleSpeak()">Speak</button>
    <div id="bark-output"></div>
    <pre>
      <code id="code" contenteditable="true">
{% include "bark.py" %}
      </code>
    </pre>
  </body>
</html>
