<!doctype html>
<html>
  <head>
    <title>bark test</title>
    <link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css">
    <script src="/bark/bark.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script>
      function code() {
        return $("#code").text();
      }

      function url() {
        return $("#url").val();   
      }

      function barkText() {
        return $('#bark-input').val();
      }


      function audioUrl(code, text) {
        const request = makeRequest(code, text);
        return url() + '?' + $.param(request);
      }


      function audioChunkHandler(chunk) {
        console.log('audio chunk', chunk);
        setAudioDataURL([chunk]);
      }

      function audioDoneHandler() {
        console.log('audio done');
      }

      function handleSpeak() {
        return getAudio(url(), code(), text(), audioChunkHandler, audioDoneHandler);
      }

      const audio = new Audio();

      function setAudioDataURL(values) {
        console.log('setting audio data url', values);
        const blob = new Blob(values, { type: 'audio/wav' });
        console.log('setting audio data url', values, blob);
        audio.src = URL.createObjectURL(blob);
        audio.play();
      }

      $(function() {
        const audioDiv = document.getElementById('bark-output');
        audio.controls = true;
        audioDiv.appendChild(audio);
        audio.addEventListener('loadeddata', () => {
          audio.play();
        });
      });
    </script>
  </head>
  <body>
    <label for="url">Exec URL</label>
    <input type="text" id="url" value="http://localhost:9876/test.wav"></input>
    <label for="bark-input">Text to speak</label>
    <textarea id="bark-input">Test sentence. And a second test.</textarea>
    <button onclick="handleSpeak">Speak</button>
    <div id="bark-output"></div>
    <pre>
      <code id="code" contenteditable="true">
{% include "bark.py" %}
      </code>
    </pre>
  </body>
</html>
